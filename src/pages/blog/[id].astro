---
import { getEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import PDFViewer from "../../components/PDFViewer.astro";
import Icon from "../../components/Icon.astro";
import LinkCTA from "../../components/LinkCTA.astro";
import { render } from "astro:content";
import { socialMediaContent, extractYouTubeId } from "../../data/socialMedia";

const { id = "" } = Astro.params;

// Try to get blog post first
const post = await getEntry("blog", id);

// If no blog post found, check if it's a video
const video = !post
  ? socialMediaContent.find((item) => item.type === "youtube" && item.id === id)
  : null;

// If neither found, redirect to blog
if (!post && !video) {
  return Astro.redirect("/blog");
}

const Content = post ? (await render(post)).Content : null;

// Check if post has PDF file
const hasPDF = post?.data.file?.endsWith(".pdf");

// Video-specific data
const videoId = video ? extractYouTubeId(video.url) : null;
---

<Layout
  seo={{
    title: `${post?.data.title || video?.title || "Content"} | José Donato`,
    description: post?.data.snippet || video?.description || "Content details",
  }}
>
  <div class="max-w-4xl mx-auto">
    <!-- Article Header -->
    <header class="mb-12 pb-8 border-b border-border-primary">
      <div class="mb-6">
        <h1
          class="text-4xl md:text-5xl font-bold text-text-primary leading-tight mb-4"
        >
          {post?.data.title || video?.title || "Content"}
        </h1>

        {
          (post?.data.snippet || video?.description) && (
            <p class="text-xl text-text-secondary leading-relaxed">
              {post?.data.snippet || video?.description}
            </p>
          )
        }
      </div>

      <div class="flex items-center justify-between">
        <div class="flex items-center gap-6 text-sm text-text-muted">
          {
            (post?.data.date || video?.date) && (
              <time>{post?.data.date || video?.date}</time>
            )
          }
          {
            post?.data.readingTime && (
              <>
                <span>•</span>
                <span>{post.data.readingTime} min read</span>
              </>
            )
          }
          {
            video && (
              <>
                <span>•</span>
                <span class="text-bullish-400 font-medium">Video</span>
              </>
            )
          }
          {
            post?.data.author && (
              <>
                <span>•</span>
                <span>By {post.data.author}</span>
              </>
            )
          }
        </div>

        <div class="flex items-center gap-4">
          {
            hasPDF && (
              <LinkCTA
                href={`/assets/${post?.data.file}`}
                text="Download PDF"
                download={true}
              />
            )
          }
          {
            video && (
              <LinkCTA
                href={video.url}
                text="Watch on YouTube"
                iconId="material-symbols-open-in-new-rounded"
                target="_blank"
                rel="noopener noreferrer"
              />
            )
          }
        </div>
      </div>
    </header>

    <!-- Content -->
    <article class="mb-16">
      {
        video ? (
          <div class="bg-bg-secondary rounded-lg overflow-hidden border border-border-primary mb-8">
            <div class="video-container">
              <iframe
                class="w-full"
                src={`https://www.youtube.com/embed/${videoId}?rel=0`}
                title={video.title || "YouTube Video"}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                style="aspect-ratio: 16/9;"
              ></iframe>
            </div>
          </div>
        ) : hasPDF ? (
          <PDFViewer pdfPath={`/assets/${post?.data.file}`} />
        ) : (
          <div class="prose dark:prose-invert prose-lg max-w-none">
            <Content />
          </div>
        )
      }
    </article>

    <!-- Back to Blog -->
    <footer class="mt-16 pt-8 border-t border-border-primary">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-text-muted hover:text-bullish-400 transition-colors"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to all content
      </a>
    </footer>
  </div>
</Layout>

<style>
  .video-container {
    position: relative;
    width: 100%;
  }
</style>
